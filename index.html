<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.6.3.slim.js" integrity="sha256-DKU1CmJ8kBuEwumaLuh9Tl/6ZB6jzGOBV/5YpNE2BWc=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js" integrity="sha512-csNcFYJniKjJxRWRV1R7fvnXrycHP6qDR21mgz1ZP55xY5d+aHLfo9/FcGDQLfn2IfngbAHd8LdfsagcCqgTcQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="variable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js" integrity="sha512-LUKzDoJKOLqnxGWWIBM4lzRBlxcva2ZTztO8bTcWPmDSpkErWx0bSP4pdsjNH8kiHAUPaT06UXcb+vOEZH+HpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div id="s-drop-img">
    <div id="s-loading" style="display: none;">Đang xử lý...</div>
    <div class="select-bg">
        <button class="active bg-none" data-color=""><span></span></button>
    </div>
    <button id="btn-saveToZip">Lưu tất cả zip</button>
    <div class="upload__img-wrap">
        <div class="upload__box">
            <div class="upload__btn-box">
                <label class="upload__btn">
                    <div>+</div>
                    <div class="inline-text-drop">Chọn (các) ảnh</div>
                    <input type="file" multiple="" accept="image/png, image/jpg" data-max_length="20" class="upload__inputFile">
                </label>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    const CONFIG = {
        colors: ['white', 'black'],
        fileName: 'Image',
        zipName: 'images.zip'
    }

    jQuery(document).ready(function () {
        ImgUpload();
    });
    function ImgUpload() {
        const $body = $('body');
        const $input = $('.upload__inputFile')
        const $boxDrop = $('#s-drop-img');
        let selectedColor = ''
        let colors = CONFIG.colors
        let imgWrap = "";
        let imgArray = [];
        let index = 0;

        colors.forEach(color => {
            $('.select-bg').append(`<button data-color="${color}"><span style="background: ${color};"></span></button>`)
        })

        $boxDrop.on('dragover', function(e) {
            e.preventDefault();
            $boxDrop.addClass('drag-over');
        });

        $boxDrop.on('dragleave', function() {
            $boxDrop.removeClass('drag-over');
        });

        $boxDrop.on('drop', function(e) {
            e.stopPropagation();
            e.preventDefault();
            $boxDrop.removeClass('drag-over');
            const files = e.originalEvent.dataTransfer.files;
            $input.prop('files', files)

            const event = $.Event('change')
            $input.trigger(event)
        })

        $input.each(async function () {
            $(this).on('change', async function (e) {
                try {
                    setLoading(true)

                    imgWrap = $('.upload__img-wrap');

                    const files = e.target.files;
                    const filesArr = Array.prototype.slice.call(files);

                    const fileImages = filesArr.filter(file => file.type.match('image.*'))

                    const res = await Promise.all(fileImages.map(async (file) => {
                        const formData = new FormData()
                        formData.append('file', file)
                        const raw = await fetch('https://chuyenreview.net/removebg.php', {
                            method: 'POST',
                            body: formData
                        })
                        return await raw.json()
                    }))

                    res.forEach((file) => {
                        ++index;
                        const name = new Date().getTime() + index;
                        imgArray.push({
                            file: file,
                            name,
                            index,
                            url: file?.image_base64
                        });
                        const html = `<div class='upload__img-box'>
                                            <div data-number='${index}' data-file='${name}' class='img-bg drop-img-item'>
                                                <img src="${file?.image_base64}" alt="">
                                                <div class='upload__img-close'></div>
                                            </div>
                                        </div>`;
                        imgWrap.prepend(html);
                    })

                    setLoading(false)
                } catch {
                    setLoading(false)
                }
            });
        });

        $body.on('click', ".upload__img-close", function (e) {
            const file = $(this).parent().data("file");
            for (let i = 0; i < imgArray.length; i++) {
                if (imgArray[i].name === file) {
                    imgArray.splice(i, 1);
                    break;
                }
            }
            $(this).parent().parent().remove();
        });

        $body.on('click', "#btn-saveToZip", async function (e) {
            await injectBgToCanvas(imgArray, selectedColor)
        })

        $body.on('click', ".select-bg button", function (e) {
            selectedColor = $(this).data('color');
            $(".select-bg button").removeClass('active')
            $(':root').css('--bg-fill', selectedColor)
            $(this).addClass('active')
        })


        function base64ToCanvas(base64, color, callback) {
            let img = new Image();
            return new Promise((resolve, reject) => {
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // create new canvas
                    const newCanvas = document.createElement('canvas');
                    newCanvas.width = canvas.width;
                    newCanvas.height = canvas.height;
                    const newCtx = newCanvas.getContext('2d');

                    // create box and fill color
                    newCtx.fillStyle = color || 'rgb(255 255 255 / 0%)';
                    newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);

                    // generate new canvas
                    newCtx.drawImage(canvas, 0, 0);

                    callback && callback(newCanvas);
                    resolve(newCanvas)
                };
                img.src = base64;
            })
        }

        function downloadCanvas (canvases) {
            try {
                const zip = new JSZip()

                for (let i = 0; i < canvases.length; i++) {
                    let canvas = canvases[i];

                    // Convert the canvas to a data URL
                    const dataURL = canvas.toDataURL();

                    // Add the data URL to the zip file
                    zip.file(`${CONFIG.fileName}_${i}.png`, dataURL.substr(dataURL.indexOf(',') + 1), {base64: true});
                }

                // Generate the zip file and download it
                zip.generateAsync({type:"blob"}).then(function(content) {
                    saveAs(content, CONFIG.zipName);
                });
            } catch (error) {
                alert(`Failed to download: ${error?.message}`)
            }

        }
        async function injectBgToCanvas (arr, color = '') {
            try {
                const canvases = await Promise.all(arr.filter(item => !!item?.url).map(async img => await base64ToCanvas(img?.url, color)))
                downloadCanvas(canvases)
            } catch(error){
                console.log({error})
            }
        }

        function setLoading(status) {
            const $el = $('#s-loading')
            $el.css('display', status ? 'flex' : 'none')
        }
    }

</script>
</html>
